---
sidebar_position: 4
---

# 热点参数限流

之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是**分别统计参数值相同的请求**，判断是否超过QPS阈值。

## 一、全局参数限流

例如，一个根据id查询商品的接口：

![image-20210716115014663](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181542169.png)

访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：

![image-20210716115131463](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181543311.png)

当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。

配置示例：

![image-20210716115232426](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181543844.png)

代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒**相同参数值**的请求数不能超过5



## 二、热点参数限流

刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.

而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：

![image-20210716115717523](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181554449.png)

结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：

•如果参数值是100，则每1秒允许的QPS为10

•如果参数值是101，则每1秒允许的QPS为15



## 三、案例

**案例需求**：给/order/{orderId}这个资源添加热点参数限流，规则如下：

•默认的热点参数规则是每1秒请求量不超过2

•给102这个参数设置例外：每1秒请求量不超过4

•给103这个参数设置例外：每1秒请求量不超过10


:::danger注意事项
热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源
:::


### 1）标记资源

给order-service中的OrderController中的/order/{orderId}资源添加注解：

![image-20210716120033572](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181554783.png)

### 2）热点参数限流规则

访问该接口，可以看到我们标记的hot资源出现了：

![image-20210716120208509](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181555191.png)

这里不要点击hot后面的按钮，页面有BUG



点击左侧菜单中**热点规则**菜单：

![image-20210716120319009](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181555518.png)

点击新增，填写表单：

![image-20210716120536714](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181555567.png)

### 3）Jmeter测试

![image-20210716120754527](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181556880.png)

这里发起请求的QPS为5.

包含3个http请求：

普通参数，QPS阈值为2

![image-20210716120840501](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181556214.png)

运行结果：

![image-20210716121105567](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181556122.png)

另一项，QPS阈值为4

![image-20210716120900365](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181556125.png)

运行结果：

![image-20210716121201630](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181557881.png)

最后一项，QPS阈值为10

![image-20210716120919131](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181557028.png)

运行结果：

![image-20210716121220305](https://cdn.jsdelivr.net/gh/studio-hu/drawingBed/img/202406181557226.png)